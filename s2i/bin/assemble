#!/bin/bash

echo "starting assemble script.."
set -e

for artifact_path in .m2 .gradle .target; do
  echo "---> Restore /tmp/artififacts/${artifact_path} to \$HOME (${HOME})"
  if [ "$(ls /tmp/artifacts/{artifact_path} 2>/dev/null)" ]; then
      mv /tmp/artifacts/{artifact_path} $HOME
  else
    echo "--> none present"
  fi
done

echo "---> Installing application source"
cp -Rf /tmp/src/. ./

echo "---> Building Spring Boot application from source"
echo "--> # MVN_ARGS = $MVN_ARGS"

npm install || true
bower update || true
bower install || true

if [ -f "build.gradle" ]; then
  echo "--> # JAVA_OPTS = $JAVA_OPTS"
  ./gradlew build $JAVA_OPTS
elif [ -f "mvnw" ]; then
  ./mvnw clean install $MVN_ARGS
else
  mvn clean install $MVN_ARGS
fi

# Fix source directory permissions
fix-permissions ./

# remove temp files created during in build
find /tmp/ -user `whoami` -delete

echo "finished assemble script.."
